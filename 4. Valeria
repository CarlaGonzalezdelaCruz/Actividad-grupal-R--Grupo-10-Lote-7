##### 4.	Crear una tabla descriptiva con las variables más importantes

pca_ind <- as.data.frame(pca$x) # Extraer los valores de los componentes principales (scores) para los individuos

# Dividir en terciles para cada componente
terciles_componente_1 <- quantile(pca_ind$PC1, probs = c(0, 1/3, 2/3, 1))
terciles_componente_2 <- quantile(pca_ind$PC2, probs = c(0, 1/3, 2/3, 1))
terciles_componente_3 <- quantile(pca_ind$PC3, probs = c(0, 1/3, 2/3, 1))
terciles_componente_4 <- quantile(pca_ind$PC4, probs = c(0, 1/3, 2/3, 1))
terciles_componente_5 <- quantile(pca_ind$PC5, probs = c(0, 1/3, 2/3, 1))

# Asignar a cada muestra su tercil correspondiente
# Creo una nueva tabla que dice para cada paciente y componente, a cual tercil corresponde el valor del score
pca_terciles <- data.frame(
  row = rownames(pca_ind),
  Componente_1 = cut(pca_ind$PC1, breaks = terciles_componente_1, labels = c("T1", "T2", "T3"), include.lowest = TRUE),
  Componente_2 = cut(pca_ind$PC2, breaks = terciles_componente_2, labels = c("T1", "T2", "T3"), include.lowest = TRUE),
  Componente_3 = cut(pca_ind$PC3, breaks = terciles_componente_3, labels = c("T1", "T2", "T3"), include.lowest = TRUE),
  Componente_4 = cut(pca_ind$PC4, breaks = terciles_componente_4, labels = c("T1", "T2", "T3"), include.lowest = TRUE),
  Componente_5 = cut(pca_ind$PC5, breaks = terciles_componente_5, labels = c("T1", "T2", "T3"), include.lowest = TRUE)
)

pca_terciles

# Evalua normalidad de la distribución de la expresión génica
#Anderson-Darling
genes <- names(Dataset_expresión_genes)[startsWith(names(Dataset_expresión_genes), "AQ")]

length(genes) #46

pvalues_adtest <- data.frame(
  Gen = character(46),                     
  Anderson_Darling_pvalue = numeric(46)    
)

for (i in 1:46) {
  pvalues_adtest[i,1] <- genes[i]
  adtest_result <- ad.test(Dataset_expresión_genes[[genes[i]]])
  pvalues_adtest[i,2] <- sprintf("%.5f", adtest_result$p.value)
}

print(arrange(pvalues_adtest, Anderson_Darling_pvalue))

# El p-valor para todas las expresiones génicas es menor a 0.05, por lo que se concluye que ningún gen mostró distribución normal según el test de Anderson-Darling
# En la tabla, calcularemos mediana y IQR


# Tabla 3 
# Creo primero una tabla que combina solo los datos que necesito, osea genes y tercil (e id)
# La convierto a long para poder aplicar luego strata

Dataset_expresión_genes <- Dataset_expresión_genes %>%
  mutate(row = row_number())

expgenica_terciles <- Dataset_expresión_genes %>%
  select(row, starts_with("AQ_")) %>%
  mutate(row = as.numeric(row)) %>% 
  left_join(pca_terciles %>% mutate(row = as.numeric(row)), by = "row") 

expgenica_CP1 <- select(expgenica_terciles, starts_with("AQ_"), Componente_1)

levene_CP1 <- data.frame(
  Gen = character(46),                     
  pvalue = numeric(46)    
)

for (i in 1:46) {
  levene_CP1[i,1] <- genes[i]
  levene <- leveneTest(expgenica_CP1[[genes[i]]], expgenica_CP1$Componente_1)
  levene_CP1[i,2] <- levene$`Pr(>F)`[1]
}

levene_CP1$Homogeneidad <- ifelse(levene_CP1$pvalue > 0.05, "Sí", "No")

print(arrange(levene_CP1, pvalue))

PC1_hom <- levene_CP1 %>% # Usamos ANOVA
  filter(Homogeneidad == "Sí") %>%
  pull(Gen)

PC1_no_hom <- levene_CP1 %>% # Usamos K-W
  filter(Homogeneidad == "No") %>%
  pull(Gen)  

resumen_PC1 <- expgenica_CP1 %>%
  tbl_summary(by = Componente_1,
              statistic = all_continuous() ~ "{median} ({p25} - {p75})",
              digits = all_continuous() ~ function(x) format(x, digits = 2, scientific = TRUE)) %>%
  add_p(test = list(all_of(PC1_hom) ~ "aov",
                    all_of(PC1_no_hom) ~ "kruskal.test"),
        pvalue_fun = ~ style_pvalue(.x, digits = 3))


